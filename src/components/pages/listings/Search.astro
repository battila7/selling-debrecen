---
import { Picture } from "astro:assets";
import listingsBg from "../../../images/listings-bg-1.jpg";
import SearchIcon from "@lucide/astro/icons/search";
import { useI18n } from "../../../i18n";

const { t } = useI18n(Astro);
---

<section
  x-data="search"
  class="relative h-[32rem] md:h-[28rem] lg:h-[32rem] w-full overflow-hidden"
>
  <div class="absolute inset-0 z-0">
    <Picture
      src={listingsBg}
      alt=""
      formats={["webp"]}
      class="w-full h-full object-cover"
      widths={[400, 800, 1200, 1600, 2000]}
      sizes="100vw"
    />
    <div class="absolute inset-0 bg-navy/80 backdrop-blur-[0px]"></div>
  </div>

  <div class="relative z-10 container mx-auto px-6 lg:px-12 h-full">
    <div class="flex flex-col items-center justify-center h-full gap-8">
      <hgroup class="text-center">
        <h1
          class="font-didone text-3xl md:text-4xl lg:text-5xl text-white tracking-wide mb-3 uppercase"
        >
          Ingatlanjaink
        </h1>
        <p class="text-white/90 text-base md:text-lg">
          Találja meg álmai ingatlanát Debrecenben
        </p>
      </hgroup>

      <!-- Search Bar -->
      <div
        class="w-full max-w-6xl bg-white rounded-lg shadow-2xl overflow-hidden"
      >
        <form
          class="flex flex-col lg:flex-row items-stretch divide-y lg:divide-y-0 divide-x divide-taupe/30"
        >
          <div class="flex-1 min-w-0">
            <fieldset class="h-full">
              <legend class="sr-only">Vásárlás vagy bérlet</legend>
              <div class="flex h-full">
                <label class="flex-1 relative">
                  <input
                    type="radio"
                    name="transaction"
                    value="sale"
                    checked
                    class="peer sr-only"
                    x-model="transactionType"
                  />
                  <span
                    class="flex items-center justify-center h-full px-4 py-4 lg:py-5 text-charcoal/60 cursor-pointer transition-all peer-checked:text-white peer-checked:bg-camel peer-checked:font-medium"
                  >
                    {t("listings.for-sale")}
                  </span>
                </label>
                <div class="w-px bg-taupe/30"></div>
                <label class="flex-1 relative">
                  <input
                    type="radio"
                    name="transaction"
                    value="rent"
                    class="peer sr-only"
                    x-model="transactionType"
                  />
                  <span
                    class="flex items-center justify-center h-full px-4 py-4 lg:py-5 text-charcoal/60 cursor-pointer transition-all peer-checked:text-white peer-checked:bg-camel peer-checked:font-medium"
                  >
                    {t("listings.for-rent")}
                  </span>
                </label>
              </div>
            </fieldset>
          </div>

          <div class="flex-1 min-w-0">
            <label class="block">
              <span class="sr-only">Ingatlan típusa</span>
              <select
                name="propertyType"
                class="w-full h-full px-4 py-4 lg:py-5 text-charcoal bg-transparent border-0 focus:outline-none transition-all cursor-pointer"
                x-model="propertyType"
              >
                <option value="apartment">lakás</option>
                <option value="house">ház</option>
                <option value="plot">telek</option>
                <option value="garage">garázs</option>
                <option value="any">mindegy</option>
              </select>
            </label>
          </div>

          <!-- Location Input -->
          <div class="flex-2 min-w-0">
            <label class="block">
              <span class="sr-only">{t("listings.location")}</span>
              <input
                type="text"
                name="location"
                placeholder={t("listings.location")}
                class="w-full h-full px-4 py-4 lg:py-5 text-charcoal bg-transparent border-0 focus:outline-none transition-all placeholder:text-charcoal/50"
                x-model="location"
              />
            </label>
          </div>

          <!-- Price Range - Desktop: side by side, Mobile: stacked -->
          <div class="flex-1 min-w-0 flex">
            <div class="flex-1">
              <label class="block">
                <span class="sr-only">Min.</span>
                <input
                  type="text"
                  name="priceMin"
                  placeholder="Min."
                  inputmode="numeric"
                  pattern="[0-9]*"
                  class="w-full h-full px-2 py-4 lg:py-5 text-charcoal bg-transparent border-0 focus:outline-none transition-all placeholder:text-charcoal/50"
                  x-model="priceMin"
                />
              </label>
            </div>
            <div class="flex items-center justify-center">
              <span class="text-charcoal/50 text-lg"> - </span>
            </div>
            <div class="flex-1">
              <label class="block">
                <span class="sr-only">Max.</span>
                <input
                  type="text"
                  name="priceMax"
                  placeholder="Max."
                  inputmode="numeric"
                  pattern="[0-9]*"
                  class="w-full h-full px-2 py-4 lg:py-5 text-charcoal bg-transparent border-0 focus:outline-none transition-all placeholder:text-charcoal/50"
                  x-model="priceMax"
                />
              </label>
            </div>
            <div
              class="flex items-center justify-center pl-1 pr-2 text-charcoal"
              x-text={`transactionType == 'sale' ? '${t("listings.million")} Ft' : '${t("listings.thousand")} Ft'`}
            >
              {t("listings.million")} Ft
            </div>
          </div>

          <!-- Square Meters Range - Desktop: side by side, Mobile: stacked -->
          <div class="flex-1 min-w-0 flex">
            <div class="flex-1">
              <label class="block">
                <span class="sr-only">Min.</span>
                <input
                  type="text"
                  name="areaMin"
                  placeholder="Min."
                  inputmode="numeric"
                  pattern="[0-9]*"
                  class="w-full h-full px-2 py-4 lg:py-5 text-charcoal bg-transparent border-0 focus:outline-none transition-all placeholder:text-charcoal/50"
                  x-model="areaMin"
                />
              </label>
            </div>
            <div class="flex items-center justify-center text-charcoal">-</div>
            <div class="flex-1">
              <label class="block">
                <span class="sr-only">Max.</span>
                <input
                  type="text"
                  name="areaMax"
                  placeholder="Max."
                  inputmode="numeric"
                  pattern="[0-9]*"
                  class="w-full h-full px-2 py-4 lg:py-5 text-charcoal bg-transparent border-0 focus:outline-none transition-all placeholder:text-charcoal/50"
                  x-model="areaMax"
                />
              </label>
            </div>
            <div
              class="flex items-center justify-center pl-1 pr-2 text-charcoal"
            >
              m²
            </div>
          </div>

          <!-- Search Button -->
          <div class="lg:flex-none">
            <button
              type="button"
              class="w-full lg:w-auto h-full px-8 py-4 lg:py-5 bg-navy text-white font-medium hover:bg-navy/90 focus:outline-none transition-all flex items-center justify-center gap-2"
              aria-label={t("listings.search")}
              @click="submitSearch"
            >
              <SearchIcon class="w-5 h-5" />
              <span class="lg:sr-only">{t("listings.search")}</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  (function initSearch() {
    document.addEventListener("alpine:init", () => {
      Alpine.data("search", () => ({
        transactionType: "sale",
        propertyType: "apartment",
        location: "",
        priceMin: "",
        priceMax: "",
        areaMin: "",
        areaMax: "",
        isInitial: true,

        init() {
          this.submitSearch();

          this.isInitial = false;
        },

        submitSearch() {
          const query = {
            transactionType: this.transactionType,
            propertyType: this.propertyType,
            location: this.location,
            priceMin: this.toPrice(this.priceMin) ?? 0,
            priceMax: this.toPrice(this.priceMax) ?? Number.MAX_SAFE_INTEGER,
            areaMin: this.toArea(this.areaMin) ?? 0,
            areaMax: this.toArea(this.areaMax) ?? Number.MAX_SAFE_INTEGER,
            isInitial: this.isInitial,
          };

          console.log("search query");
          console.log(query);

          this.$dispatch("search", query);
        },

        toPrice(value: string) {
          const valueNumber = this.toNumberOrMissing(value);

          if (!valueNumber) {
            return null;
          }

          return valueNumber * this.priceMultiplier;
        },

        toArea(value: string) {
          return this.toNumberOrMissing(value);
        },

        get priceMultiplier() {
          return this.transactionType == "sale" ? 1000000 : 1000;
        },

        toNumberOrMissing(value: string) {
          if (value === "") {
            return null;
          }
          return Number(value);
        },
      }));
    });
  })();
</script>
