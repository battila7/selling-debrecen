---
import ChevronLeft from "@lucide/astro/icons/chevron-left";
import ChevronRight from "@lucide/astro/icons/chevron-right";
import X from "@lucide/astro/icons/x";
import { useI18n } from "../../../i18n";

type Props = {
  images: { src: string; alt: string }[];
};

const { images } = Astro.props;
const { t } = useI18n(Astro);
---

<section
  class="bg-charcoal"
  x-data="carousel"
  @keydown.window.escape="closeLightbox()"
  @keydown.window.left="lightboxOpen && lightboxPrev()"
  @keydown.window.right="lightboxOpen && lightboxNext()"
>
  <div
    class="relative w-full aspect-[4/3] sm:aspect-[16/9] md:aspect-[21/9] lg:aspect-[21/7] overflow-hidden"
    @touchstart="handleTouchStart"
    @touchend="handleTouchEnd"
  >
    <!-- Images Container with Sliding Effect -->
    <div
      class="flex h-full transition-transform duration-300 ease-out"
      :style="`transform: translateX(-${currentIndex * 100}%)`"
    >
      {
        images.map((image, index) => (
          <img
            src={image.src}
            alt={image.alt}
            class="flex-shrink-0 w-full h-full object-cover cursor-zoom-in"
            x-on:click={`openLightbox(${index})`}
          />
        ))
      }
    </div>

    <button
      type="button"
      x-on:click="prev"
      class="hidden md:flex absolute left-4 md:left-8 top-1/2 -translate-y-1/2 bg-cream/90 hover:bg-cream p-3 md:p-4 border-2 border-navy/20 hover:border-navy transition-all duration-300 group items-center justify-center"
      aria-label={t("listing-detail.previous-image")}
    >
      <ChevronLeft
        size={28}
        class="text-navy transition-transform duration-300 group-hover:-translate-x-1"
      />
    </button>

    <button
      type="button"
      x-on:click="next"
      class="hidden md:flex absolute right-4 md:right-8 top-1/2 -translate-y-1/2 bg-cream/90 hover:bg-cream p-3 md:p-4 border-2 border-navy/20 hover:border-navy transition-all duration-300 group items-center justify-center"
      aria-label={t("listing-detail.next-image")}
    >
      <ChevronRight
        size={28}
        class="text-navy transition-transform duration-300 group-hover:translate-x-1"
      />
    </button>

    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-3">
      {
        images.map((_, index) => (
          <button
            type="button"
            x-on:click={`goTo(${index})`}
            class="w-3 h-3 border-2 border-cream transition-all duration-300"
            x-bind:class={`currentIndex === ${index} ? 'bg-cream' : 'bg-transparent hover:bg-cream/50'`}
            aria-label={`${t("listing-detail.go-to-image")} ${index + 1}`}
          />
        ))
      }
    </div>

    <div
      class="absolute top-6 right-6 bg-charcoal/80 px-4 py-2 border border-cream/30"
    >
      <p
        class="font-geometric-humanist text-sm text-cream tracking-wider"
        x-text={`(currentIndex + 1) + ' / ' + images.length`}
      >
        1 / {images.length}
      </p>
    </div>
  </div>

  <!-- Full-Screen Lightbox -->
  <template x-teleport="body">
    <div
      x-show="lightboxOpen"
      x-transition:enter="transition-opacity ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition-opacity ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      @click="closeLightbox()"
      x-trap.inert.noscroll="lightboxOpen"
      class="fixed inset-0 z-[999] flex items-center justify-center bg-charcoal/95 select-none cursor-zoom-out"
      style="display: none;"
    >
      <!-- Close Button -->
      <button
        type="button"
        @click="closeLightbox()"
        class="absolute top-6 right-6 z-10 bg-cream/10 hover:bg-cream/20 p-3 border-2 border-cream/30 hover:border-cream transition-all duration-300 group cursor-pointer"
        aria-label={t("listing-detail.close")}
      >
        <X size={28} class="text-cream" />
      </button>

      <!-- Image Counter -->
      <div
        class="absolute top-6 left-6 z-10 bg-cream/10 px-4 py-3 border-2 border-cream/30"
      >
        <p
          class="font-geometric-humanist text-base text-cream tracking-wider"
          x-text={`(lightboxIndex + 1) + ' / ' + images.length`}
        >
          1 / {images.length}
        </p>
      </div>

      <!-- Navigation and Image Container -->
      <div
        class="relative w-11/12 xl:w-4/5 h-[85vh] flex items-center justify-center"
      >
        <button
          type="button"
          @click.stop="lightboxPrev()"
          class="hidden md:flex absolute left-0 z-10 -translate-x-4 xl:-translate-x-20 2xl:-translate-x-28 bg-cream/10 hover:bg-cream/20 p-4 border-2 border-cream/30 hover:border-cream transition-all duration-300 group cursor-pointer items-center justify-center"
          aria-label={t("listing-detail.previous-image")}
        >
          <ChevronLeft
            size={32}
            class="text-cream transition-transform duration-300 group-hover:-translate-x-1"
          />
        </button>

        <!-- Images Container with Sliding Effect -->
        <div
          class="w-full h-full overflow-hidden"
          @touchstart.stop="handleTouchStart"
          @touchend.stop="handleTouchEnd"
        >
          <div
            class="flex h-full items-center transition-transform duration-300 ease-out"
            :style="`transform: translateX(-${lightboxIndex * 100}%)`"
          >
            {
              images.map((image) => (
                <div class="flex-shrink-0 w-full h-full flex items-center justify-center">
                  <img
                    src={image.src}
                    alt={image.alt}
                    class="max-w-full max-h-full object-contain select-none cursor-zoom-out"
                  />
                </div>
              ))
            }
          </div>
        </div>

        <button
          type="button"
          @click.stop="lightboxNext()"
          class="hidden md:flex absolute right-0 z-10 translate-x-4 xl:translate-x-20 2xl:translate-x-28 bg-cream/10 hover:bg-cream/20 p-4 border-2 border-cream/30 hover:border-cream transition-all duration-300 group cursor-pointer items-center justify-center"
          aria-label={t("listing-detail.next-image")}
        >
          <ChevronRight
            size={32}
            class="text-cream transition-transform duration-300 group-hover:translate-x-1"
          />
        </button>
      </div>
      <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-10 flex gap-2">
        {
          images.map((_, index) => (
            <button
              type="button"
              @click.stop={`lightboxIndex = ${index}`}
              class="w-3 h-3 border-2 border-cream transition-all duration-300 cursor-pointer"
              x-bind:class={`lightboxIndex === ${index} ? 'bg-cream' : 'bg-transparent hover:bg-cream/50'`}
              aria-label={`${t("listing-detail.go-to-image")} ${index + 1}`}
            />
          ))
        }
      </div>
    </div>
  </template>
</section>

<script data-images={JSON.stringify(images)}>
  (function initCarousel() {
    const dataset = document.currentScript.dataset;

    document.addEventListener("alpine:init", () => {
      Alpine.data("carousel", () => ({
        currentIndex: 0,
        lightboxOpen: false,
        lightboxIndex: 0,
        images: JSON.parse(dataset.images),
        touchStartX: 0,
        touchEndX: 0,
        get currentImage() {
          return this.images[this.currentIndex];
        },
        next() {
          this.currentIndex = (this.currentIndex + 1) % this.images.length;
        },
        prev() {
          this.currentIndex =
            (this.currentIndex - 1 + this.images.length) % this.images.length;
        },
        goTo(index) {
          this.currentIndex = index;
        },
        openLightbox(index) {
          this.lightboxIndex = index;
          this.lightboxOpen = true;
          document.body.style.overflow = "hidden";
        },
        closeLightbox() {
          this.lightboxOpen = false;
          document.body.style.overflow = "";
        },
        lightboxNext() {
          this.lightboxIndex = (this.lightboxIndex + 1) % this.images.length;
        },
        lightboxPrev() {
          this.lightboxIndex =
            (this.lightboxIndex - 1 + this.images.length) % this.images.length;
        },
        handleTouchStart(e) {
          this.touchStartX = e.touches[0].clientX;
        },
        handleTouchEnd(e) {
          this.touchEndX = e.changedTouches[0].clientX;
          this.handleSwipe();
        },
        handleSwipe() {
          const swipeThreshold = 50;
          const diff = this.touchStartX - this.touchEndX;

          if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
              // Swiped left - go to next
              if (this.lightboxOpen) {
                this.lightboxNext();
              } else {
                this.next();
              }
            } else {
              // Swiped right - go to previous
              if (this.lightboxOpen) {
                this.lightboxPrev();
              } else {
                this.prev();
              }
            }
          }
        },
      }));
    });
  })();
</script>
