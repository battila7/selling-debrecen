---
import listingPlaceholder from "../../images/listing-placeholder.jpg";
import agentProfilePicture from "../../images/agent-profile-picture-placeholder.jpg";
import bathroom from "../../images/bathroom.jpg";
import kitchen from "../../images/kitchen.jpg";
import { PageLayout } from "../../layouts";
import { Image } from "astro:assets";

import MapPin from "@lucide/astro/icons/map-pin";
import House from "@lucide/astro/icons/house";
import Maximize2 from "@lucide/astro/icons/maximize-2";
import Building2 from "@lucide/astro/icons/building-2";
import Hash from "@lucide/astro/icons/hash";
import Calendar from "@lucide/astro/icons/calendar";
import Phone from "@lucide/astro/icons/phone";
import Check from "@lucide/astro/icons/check";
import Copy from "@lucide/astro/icons/copy";
import SearchIcon from "@lucide/astro/icons/search";
import MessageCircle from "@lucide/astro/icons/message-circle";
import ChevronLeft from "@lucide/astro/icons/chevron-left";
import ChevronRight from "@lucide/astro/icons/chevron-right";
import X from "@lucide/astro/icons/x";
import ZoomIn from "@lucide/astro/icons/zoom-in";
import ZoomOut from "@lucide/astro/icons/zoom-out";

import type { GetStaticPaths } from "astro";

export const getStaticPaths = (() => {
  const listings = [
    {
      id: "32",
      slug: "elegans-csaladi-haz-a-belvarosban",
      title: "Elegáns családi ház a belvárosban",
      address: "Debrecen, Belváros, Piac utca 45.",
      price: 125000000,
      image: listingPlaceholder.src,
      imageAlt: "Elegáns családi ház a belvárosban",
      images: [
        { src: listingPlaceholder.src, alt: "Elegáns családi ház - Kívülről" },
        { src: listingPlaceholder.src, alt: "Elegáns családi ház - Nappali" },
        { src: listingPlaceholder.src, alt: "Elegáns családi ház - Konyha" },
        { src: listingPlaceholder.src, alt: "Elegáns családi ház - Hálószoba" },
        { src: listingPlaceholder.src, alt: "Elegáns családi ház - Kert" },
      ],
      rooms: 5,
      area: 180,
      propertyType: "house",
      transactionType: "sale",
      description:
        "Kiváló elhelyezkedésű, gondosan felújított családi ház a belváros szívében. Tágas szobák, modern konyha, összkomfortos fürdőszobák. Csendes, nyugodt környezet, közel minden szolgáltatáshoz.",
      link: "",
      extra: "Hatalmas kert",
      checklist: ["Hatalmas kert", "Két kocsibeálló", "Boltok a közelben"],
    },
    {
      id: "33",
      slug: "modern-lakas-a-belvarosban",
      title: "Modern lakás a belvárosban",
      address: "Debrecen, Belváros, Egyetem tér 12.",
      price: 45000000,
      image: listingPlaceholder.src,
      imageAlt: "Elegáns családi ház a belvárosban",
      images: [
        { src: listingPlaceholder.src, alt: "Modern lakás - Kívülről" },
        { src: bathroom.src, alt: "Modern lakás - Fürdő" },
        { src: kitchen.src, alt: "Modern lakás - Konyha" },
      ],
      rooms: 5,
      area: 180,
      propertyType: "apartment",
      transactionType: "sale",
      description:
        "Kiváló elhelyezkedésű, gondosan felújított családi ház a belváros szívében. Tágas szobák, modern konyha, összkomfortos fürdőszobák. Csendes, nyugodt környezet, közel minden szolgáltatáshoz.",
      link: "",
      extra: "Hatalmas kert",
      checklist: ["Hatalmas kert", "Két kocsibeálló", "Boltok a közelben"],
    },
  ];

  listings.forEach((listing) => {
    listing.link = `/i/${listing.id}-${listing.slug}`;
  });

  return listings.map((listing) => ({
    params: {
      identifier: listing.id,
      slug: listing.slug,
    },
    props: {
      listing,
    },
  }));
}) satisfies GetStaticPaths;

interface Props {
  listing: {
    id: string;
    slug: string;
    title: string;
    address: string;
    price: number;
    image: string;
    imageAlt: string;
    images: Array<{ src: string; alt: string }>;
    rooms: number;
    area: number;
    propertyType: string;
    transactionType: string;
    description: string;
    link: string;
    extra: string;
    checklist: string[];
  };
}

const { listing } = Astro.props;

const formattedPrice = listing.price.toLocaleString("hu-HU") + " Ft";

const propertyTypeLabels: Record<string, string> = {
  house: "Családi ház",
  apartment: "Lakás",
};

const transactionTypeLabels: Record<string, string> = {
  sale: "Eladó",
  rent: "Kiadó",
};
---

<PageLayout title={listing.title} description={listing.description}>
  <!--
  <section class="bg-cream-soft border-b border-taupe/30 py-6">
    <div class="container mx-auto px-6 lg:px-12">
      <a
        href="/ingatlanjaink"
        class="inline-flex items-center gap-2 text-charcoal/70 hover:text-navy transition-colors duration-500 group"
      >
        <ArrowLeft
          size={18}
          class="transition-transform duration-500 group-hover:-translate-x-1"
        />
        <span
          class="font-geometric-humanist text-sm tracking-wide uppercase font-semibold"
        >
          Vissza az ingatlanokhoz
        </span>
      </a>
    </div>
  </section>
  -->

  <!-- Hero Carousel Section -->
  <section
    class="bg-charcoal"
    x-data=`{
      currentIndex: 0,
      lightboxOpen: false,
      lightboxIndex: 0,
      images: ${JSON.stringify(listing.images)},
      touchStartX: 0,
      touchEndX: 0,
      get currentImage() {
        return this.images[this.currentIndex];
      },
      next() {
        this.currentIndex = (this.currentIndex + 1) % this.images.length;
      },
      prev() {
        this.currentIndex = (this.currentIndex - 1 + this.images.length) % this.images.length;
      },
      goTo(index) {
        this.currentIndex = index;
      },
      openLightbox(index) {
        this.lightboxIndex = index;
        this.lightboxOpen = true;
        document.body.style.overflow = 'hidden';
      },
      closeLightbox() {
        this.lightboxOpen = false;
        document.body.style.overflow = '';
      },
      lightboxNext() {
        this.lightboxIndex = (this.lightboxIndex + 1) % this.images.length;
      },
      lightboxPrev() {
        this.lightboxIndex = (this.lightboxIndex - 1 + this.images.length) % this.images.length;
      },
      handleTouchStart(e) {
        this.touchStartX = e.touches[0].clientX;
      },
      handleTouchEnd(e) {
        this.touchEndX = e.changedTouches[0].clientX;
        this.handleSwipe();
      },
      handleSwipe() {
        const swipeThreshold = 50;
        const diff = this.touchStartX - this.touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0) {
            // Swiped left - go to next
            if (this.lightboxOpen) {
              this.lightboxNext();
            } else {
              this.next();
            }
          } else {
            // Swiped right - go to previous
            if (this.lightboxOpen) {
              this.lightboxPrev();
            } else {
              this.prev();
            }
          }
        }
      }
    }`
    @keydown.window.escape="closeLightbox()"
    @keydown.window.left="lightboxOpen && lightboxPrev()"
    @keydown.window.right="lightboxOpen && lightboxNext()"
  >
    <div
      class="relative w-full aspect-[4/3] sm:aspect-[16/9] md:aspect-[21/9] lg:aspect-[21/7] overflow-hidden"
      @touchstart="handleTouchStart"
      @touchend="handleTouchEnd"
    >
      <!-- Images -->
      {
        listing.images.map((image, index) => (
          <img
            src={image.src}
            alt={image.alt}
            class="absolute inset-0 w-full h-full object-cover cursor-zoom-in"
            x-show={`currentIndex === ${index}`}
            x-transition:enter="transition-opacity ease-in-out duration-500"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-in-out duration-500"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            x-on:click={`openLightbox(${index})`}
          />
        ))
      }

      <!-- Zoom indicator -->
      <div
        class="absolute top-6 left-6 bg-charcoal/80 px-3 py-2 border border-cream/30 pointer-events-none"
      >
        <ZoomIn size={20} class="text-cream" />
      </div>

      <!-- Navigation Buttons (hidden on mobile) -->
      {
        listing.images.length > 1 && (
          <>
            <button
              type="button"
              x-on:click="prev"
              class="hidden md:flex absolute left-4 md:left-8 top-1/2 -translate-y-1/2 bg-cream/90 hover:bg-cream p-3 md:p-4 border-2 border-navy/20 hover:border-navy transition-all duration-300 group items-center justify-center"
              aria-label="Előző kép"
            >
              <ChevronLeft
                size={28}
                class="text-navy transition-transform duration-300 group-hover:-translate-x-1"
              />
            </button>

            <button
              type="button"
              x-on:click="next"
              class="hidden md:flex absolute right-4 md:right-8 top-1/2 -translate-y-1/2 bg-cream/90 hover:bg-cream p-3 md:p-4 border-2 border-navy/20 hover:border-navy transition-all duration-300 group items-center justify-center"
              aria-label="Következő kép"
            >
              <ChevronRight
                size={28}
                class="text-navy transition-transform duration-300 group-hover:translate-x-1"
              />
            </button>
          </>
        )
      }

      <!-- Indicators -->
      {
        listing.images.length > 1 && (
          <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-3">
            {listing.images.map((_, index) => (
              <button
                type="button"
                x-on:click={`goTo(${index})`}
                class="w-3 h-3 border-2 border-cream transition-all duration-300"
                x-bind:class={`currentIndex === ${index} ? 'bg-cream' : 'bg-transparent hover:bg-cream/50'`}
                aria-label={`Ugrás a ${index + 1}. képre`}
              />
            ))}
          </div>
        )
      }

      <!-- Image Counter -->
      {
        listing.images.length > 1 && (
          <div class="absolute top-6 right-6 bg-charcoal/80 px-4 py-2 border border-cream/30">
            <p
              class="font-geometric-humanist text-sm text-cream tracking-wider"
              x-text={`(currentIndex + 1) + ' / ' + images.length`}
            >
              1 / {listing.images.length}
            </p>
          </div>
        )
      }
    </div>

    <!-- Full-Screen Lightbox -->
    <template x-teleport="body">
      <div
        x-show="lightboxOpen"
        x-transition:enter="transition-opacity ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        @click="closeLightbox()"
        x-trap.inert.noscroll="lightboxOpen"
        class="fixed inset-0 z-[999] flex items-center justify-center bg-charcoal/95 select-none cursor-zoom-out"
        style="display: none;"
      >
        <!-- Close Button -->
        <button
          type="button"
          @click="closeLightbox()"
          class="absolute top-6 right-6 z-10 bg-cream/10 hover:bg-cream/20 p-3 border-2 border-cream/30 hover:border-cream transition-all duration-300 group cursor-pointer"
          aria-label="Bezárás"
        >
          <X size={28} class="text-cream" />
        </button>

        <!-- Image Counter -->
        <div
          class="absolute top-6 left-6 z-10 bg-cream/10 px-4 py-3 border-2 border-cream/30"
        >
          <p
            class="font-geometric-humanist text-base text-cream tracking-wider"
            x-text={`(lightboxIndex + 1) + ' / ' + images.length`}
          >
            1 / {listing.images.length}
          </p>
        </div>

        <!-- Zoom Out Indicator -->
        <div
          class="absolute bottom-6 left-6 z-10 bg-cream/10 px-3 py-2 border-2 border-cream/30 pointer-events-none"
        >
          <ZoomOut size={20} class="text-cream" />
        </div>

        <!-- Navigation and Image Container -->
        <div
          class="relative w-11/12 xl:w-4/5 h-[85vh] flex items-center justify-center"
          @touchstart.stop="handleTouchStart"
          @touchend.stop="handleTouchEnd"
        >
          <!-- Previous Button (hidden on mobile) -->
          {
            listing.images.length > 1 && (
              <button
                type="button"
                @click.stop="lightboxPrev()"
                class="hidden md:flex absolute left-0 z-10 -translate-x-4 xl:-translate-x-20 2xl:-translate-x-28 bg-cream/10 hover:bg-cream/20 p-4 border-2 border-cream/30 hover:border-cream transition-all duration-300 group cursor-pointer items-center justify-center"
                aria-label="Előző kép"
              >
                <ChevronLeft
                  size={32}
                  class="text-cream transition-transform duration-300 group-hover:-translate-x-1"
                />
              </button>
            )
          }

          <!-- Image -->
          {
            listing.images.map((image, index) => (
              <img
                x-show={`lightboxIndex === ${index}`}
                src={image.src}
                alt={image.alt}
                class="max-w-full max-h-full object-contain select-none cursor-zoom-out"
                style="display: none;"
              />
            ))
          }

          <!-- Next Button (hidden on mobile) -->
          {
            listing.images.length > 1 && (
              <button
                type="button"
                @click.stop="lightboxNext()"
                class="hidden md:flex absolute right-0 z-10 translate-x-4 xl:translate-x-20 2xl:translate-x-28 bg-cream/10 hover:bg-cream/20 p-4 border-2 border-cream/30 hover:border-cream transition-all duration-300 group cursor-pointer items-center justify-center"
                aria-label="Következő kép"
              >
                <ChevronRight
                  size={32}
                  class="text-cream transition-transform duration-300 group-hover:translate-x-1"
                />
              </button>
            )
          }
        </div>

        <!-- Thumbnail Navigation (Optional - for listings with many images) -->
        {
          listing.images.length > 1 && listing.images.length <= 10 && (
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-10 flex gap-2">
              {listing.images.map((_, index) => (
                <button
                  type="button"
                  @click.stop={`lightboxIndex = ${index}`}
                  class="w-3 h-3 border-2 border-cream transition-all duration-300 cursor-pointer"
                  x-bind:class={`lightboxIndex === ${index} ? 'bg-cream' : 'bg-transparent hover:bg-cream/50'`}
                  aria-label={`Ugrás a ${index + 1}. képre`}
                />
              ))}
            </div>
          )
        }
      </div>
    </template>
  </section>

  <!-- Main Content -->
  <section class="bg-cream py-16">
    <div class="container mx-auto px-6 lg:px-12">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Left Column - Main Details -->
        <div class="order-2 lg:order-1 lg:col-span-2 space-y-12">
          <!-- Title and Address -->
          <div>
            <h1
              class="font-old-style text-4xl md:text-5xl text-charcoal mb-6 tracking-wide leading-tight"
            >
              {listing.title}
            </h1>
            <div class="flex flex-col lg:flex-row gap-3 lg:gap-6">
              <div class="flex items-start gap-3 text-charcoal/70">
                <MapPin size={24} class="mt-1 flex-shrink-0" />
                <p class="font-geometric-humanist text-lg tracking-wide">
                  {listing.address}
                </p>
              </div>
              <div class="flex items-start gap-3 text-charcoal/70">
                <Hash size={24} class="mt-1 flex-shrink-0" />
                <p class="font-geometric-humanist text-lg tracking-wide">
                  Hivatkozási szám: {listing.id}
                </p>
              </div>
              <button
                class="flex items-start gap-3 text-charcoal/70 hover:text-navy transition-colors duration-500 cursor-pointer"
                type="button"
                x-data=`{
                  copied: false,
                  link: '${listing.link}'
                }`
                x-on:click=`
                  navigator.clipboard.writeText(link).then(() => {
                    copied = true;
                    setTimeout(() => copied = false, 2000);
                  })
                `
              >
                <Copy size={24} class="mt-1 flex-shrink-0" />
                <p
                  x-text="copied ? 'Másolva!' : 'Link másolása'"
                  class="font-geometric-humanist text-lg tracking-wide"
                >
                  Link másolása
                </p>
              </button>
            </div>
          </div>
          <!-- Divider -->
          <div class="border-t-2 border-taupe/40"></div>

          <!-- Description -->
          <div>
            <h2 class="font-old-style text-2xl text-charcoal tracking-wide">
              Leírás
            </h2>
            <p
              class="font-system-ui text-lg text-charcoal/80 leading-relaxed whitespace-pre-line"
            >
              {listing.description}
            </p>
          </div>

          <!-- Divider -->
          <div class="border-t-2 border-taupe/40"></div>

          <!-- Key Features -->
          <div>
            <h2
              class="font-old-style text-2xl text-charcoal mb-6 tracking-wide"
            >
              Főbb jellemzők
            </h2>
            <ul class="space-y-4">
              {
                listing.checklist.map((item) => (
                  <li class="flex items-start gap-4">
                    <div class="bg-navy/10 p-2 mt-0.5 flex-shrink-0">
                      <Check size={20} class="text-navy" />
                    </div>
                    <p class="font-system-ui text-lg text-charcoal/80 leading-relaxed">
                      {item}
                    </p>
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <!-- Right Column - Price and Contact -->
        <div class="order-1 lg:order-2 lg:col-span-1">
          <div class="sticky top-20 space-y-6">
            <!-- Price Card -->
            <div class="bg-navy border-2 border-navy p-8">
              <p
                class="font-geometric-humanist text-xs text-cream/80 uppercase tracking-wider mb-3"
              >
                Kért ár
              </p>
              <p
                class="font-old-style text-4xl text-cream font-bold tracking-wide mb-2"
              >
                {formattedPrice}
              </p>
            </div>

            <!-- Property Details Card -->
            <div
              class="bg-cream-soft border-2 border-taupe/30 p-8 grid grid-cols-1 lg:grid-cols-2 gap-6"
            >
              <div class="flex items-center gap-4">
                <div class="bg-navy/10 p-4">
                  <Maximize2 size={32} class="text-navy" />
                </div>
                <div>
                  <p
                    class="font-geometric-humanist text-xs text-charcoal/60 uppercase tracking-wider mb-1"
                  >
                    Alapterület
                  </p>
                  <p class="font-old-style text-xl text-charcoal font-bold">
                    {listing.area} m²
                  </p>
                </div>
              </div>

              <div class="flex items-center gap-4">
                <div class="bg-navy/10 p-4">
                  {
                    listing.propertyType === "house" ? (
                      <House size={32} class="text-navy" />
                    ) : (
                      <Building2 size={32} class="text-navy" />
                    )
                  }
                </div>
                <div>
                  <p
                    class="font-geometric-humanist text-xs text-charcoal/60 uppercase tracking-wider mb-1"
                  >
                    Típus
                  </p>
                  <p class="font-old-style text-xl text-charcoal font-bold">
                    {propertyTypeLabels[listing.propertyType]}
                  </p>
                </div>
              </div>
            </div>

            <!-- Contact Card -->
            <div class="bg-cream-soft border-2 border-taupe/30 p-8 space-y-6">
              <h3 class="font-old-style text-2xl text-charcoal tracking-wide">
                Érdeklődés
              </h3>
              <p
                class="font-system-ui text-sm text-charcoal/70 leading-relaxed"
              >
                Felkeltettük az érdeklődését? Keressen minket bizalommal!
              </p>

              <!-- CTA Buttons -->
              <div class="space-y-3">
                <a
                  href="/idopontfoglalas"
                  class="flex items-center justify-center gap-3 w-full px-6 py-4 bg-navy text-cream font-geometric-humanist text-sm tracking-widest uppercase font-semibold border-2 border-navy hover:bg-transparent hover:text-navy transition-colors duration-700"
                >
                  <Calendar size={20} />
                  <span>Időpontfoglalás</span>
                </a>

                <a
                  href="/kapcsolat"
                  class="flex items-center justify-center gap-3 w-full px-6 py-4 bg-transparent text-navy font-geometric-humanist text-sm tracking-widest uppercase font-semibold border-2 border-navy hover:bg-navy hover:text-cream transition-colors duration-700"
                >
                  <Phone size={20} />
                  <span>Kapcsolat</span>
                </a>
              </div>

              <!-- Agent Info -->
              <div class="pt-6 border-t border-taupe/40">
                <p
                  class="font-geometric-humanist text-xs text-charcoal/60 uppercase tracking-wider mb-4"
                >
                  Az Ön tanácsadója
                </p>
                <div class="flex items-center gap-4">
                  <Image
                    src={agentProfilePicture}
                    alt="Kiss Zoltán"
                    class="w-16 h-16 object-cover border-2 border-taupe/30"
                  />
                  <p class="font-old-style text-xl text-charcoal tracking-wide">
                    Kiss Zoltán
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- End marker -->
      <div class="max-w-4xl mx-auto mt-20 mb-8">
        <div class="w-32 mx-auto border-t border-taupe/40 mb-10"></div>

        <p
          class="font-old-style text-center text-xl md:text-2xl text-charcoal/60 mb-12 tracking-wide"
        >
          További ingatlanjaink
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 px-4">
          <!-- Browse Listings Card -->
          <a
            href="/ingatlanjaink"
            class="group cursor-pointer block text-left bg-cream-soft border-2 border-navy/20 p-8 hover:border-navy hover:bg-navy transition-all duration-700"
          >
            <div class="flex items-start gap-4">
              <div
                class="flex-shrink-0 p-3 bg-navy/10 group-hover:bg-cream transition-colors duration-700"
              >
                <SearchIcon class="w-8 h-8 text-navy group-hover:text-navy" />
              </div>
              <div class="flex-1">
                <h3
                  class="font-old-style text-2xl text-navy group-hover:text-cream mb-3 tracking-wide transition-colors duration-700"
                >
                  Keresés
                </h3>
                <p
                  class="font-system-ui text-sm text-charcoal/70 group-hover:text-cream/90 leading-relaxed transition-colors duration-700"
                >
                  Böngéssze teljes kínálatunkat, és találja meg az Önnek
                  legmegfelelőbb ingatlant.
                </p>
              </div>
            </div>
          </a>

          <!-- Contact Card -->
          <a
            href="/idopontfoglalas"
            class="group cursor-pointer block text-left bg-cream-soft border-2 border-navy/20 p-8 hover:border-navy hover:bg-navy transition-all duration-700"
          >
            <div class="flex items-start gap-4">
              <div
                class="flex-shrink-0 p-3 bg-navy/10 group-hover:bg-cream transition-colors duration-700"
              >
                <MessageCircle
                  class="w-8 h-8 text-navy group-hover:text-navy"
                />
              </div>
              <div class="flex-1">
                <h3
                  class="font-old-style text-2xl text-navy group-hover:text-cream mb-3 tracking-wide transition-colors duration-700"
                >
                  Időpontfoglalás
                </h3>
                <p
                  class="font-system-ui text-sm text-charcoal/70 group-hover:text-cream/90 leading-relaxed transition-colors duration-700"
                >
                  Személyre szabott ajánlatért és részletes tanácsadásért
                  keressen minket bizalommal!
                </p>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </section>
</PageLayout>
